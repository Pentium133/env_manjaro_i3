#! /usr/bin/env sh

source utils

cb=''
cb_on=''

function todo(){
  local task=$1
  local text=$2
  local id=$(short_id)
  echo "$cb [$task-$id] $text"
}

function todos(){
  local task
  local file
  local state=()

  for i in "$@"; do
    case $i in
      -t=*|--task=*)
        task="${i#*=}"
        shift
        ;;
      -c|--closed)
        state+=$cb_on
        shift
        ;;
      -o|--opened)
        state+=$cb
        shift
        ;;
      *)
        file="$i"
        shift
      ;;
    esac
  done

  if [ ${#state[@]} -eq 0 ]; then
    state=($cb_on $cb)
  fi


  local pattern=$(mkstring $state -d='\|')
  if [[ -n $task  ]]; then
    pattern="\(${pattern}\)${anychar}\[${anychar}${task}${anychar}\]"
  fi

  find_line $file $pattern
}


function todo_add(){
  local file=$1
  local task=$2
  local text=$3
  local id=$(short_id)
  local fullid="$task-$id"
  local result="$cb [$fullid] $text"

  if newline_at_eof $file; then
    echo $result >> $file
  else
    echo -n $result >> $file
    echo "" >> $file
  fi

  echo $fullid
}

function _extract_all(){
  local grpState="${cb}|${cb_on}"
  local grpIdentity="[-_a-zA-Z0-9]+"
  local regex="(${grpState})\s+\[(${grpIdentity})\|(${grpIdentity})\]\s+(.*)"

  local fields=("${(@f)$(extract_regex_groups $1 $regex; echo .)}")
  unset 'fields[-1]'

  for f in ${fields[@]}; do
    echo $f
  done
}

function _extract_body(){
  local grpState="${cb}|${cb_on}"
  local grpBody=".*"
  local regex="(${grpState})\s+($grpBody)"

  local fields=("${(@f)$(extract_regex_groups $1 $regex; echo .)}")
  unset 'fields[-1]'

  echo ${fields[3]}
}

function _extract_state(){
  local fields=("${(@f)$(_extract_all $1; echo .)}")
  unset 'fields[-1]'

  echo ${fields[2]}
}

function _extract_group(){
  local fields=("${(@f)$(_extract_all $1; echo .)}")
  unset 'fields[-1]'

  echo ${fields[3]}
}

function _extract_id(){
  local fields=("${(@f)$(_extract_all $1; echo .)}")
  unset 'fields[-1]'

  echo ${fields[4]}
}

function _extract_task(){
  local group=$(_extract_group $1)
  local id=$(_extract_id $1)
  echo "${group}|${id}"
}

function _extract_text(){
  local fields=("${(@f)$(_extract_all $1; echo .)}")
  unset 'fields[-1]'

  echo ${fields[5]}
}

function todo_state(){
  local file
  local task
  local striked=0
  
  for i in "$@"; do
    case $i in
      -t=*|--task=*)
        task="${i#*=}"
        shift
        ;;
      -c|--closed)
        striked=1
        shift
        ;;
      -o|--opened)
        striked=0
        shift
        ;;
      *)
        file="$i"
        shift
      ;;
    esac
  done

  local array_of_lines=("${(@f)$(todos $file -t=$task; echo .)}")
  unset 'array_of_lines[-1]'


  for e in $array_of_lines[@];do
    local state=$(_extract_state $e)
    local body=$(_extract_body $e)

    if [[ $striked = 1 ]]; then
      local result=$(replace $e $cb $cb_on)
      #result=$(decorate $result "~~")
      
    else
      local result=$(replace $e $cb_on $cb)
      #result=$(drop_left $result 2)
      #result=$(drop_right $result 2)
    fi

    
    replace_in_file $file $e $result
  done
}

